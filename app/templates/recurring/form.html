{% extends "base.html" %}

{% block page_title %}{% if recurring_invoice %}Edit Recurring Invoice{% else %}New Recurring Invoice{% endif %}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <form method="POST" class="bg-white rounded-xl shadow-md p-8 space-y-8">
        <!-- Header -->
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">{% if recurring_invoice %}Edit Recurring Invoice{% else %}New Recurring Invoice{% endif %}</h1>
                <p class="mt-2 text-gray-600">Set up automated invoices for your clients.</p>
            </div>
            <a href="{{ url_for('recurring_invoices.index') }}" class="text-gray-600 hover:text-gray-900">&larr; Back to Recurring Invoices</a>
        </div>

        <!-- Client Selection -->
        <div>
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Client</h2>
            <select name="client_id" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                <option value="">Select a client</option>
                {% for client in clients %}
                <option value="{{ client.id }}" {% if recurring_invoice and recurring_invoice.client_id == client.id %}selected{% endif %}>{{ client.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Recurrence Schedule -->
        <div>
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Recurrence Schedule</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="frequency" class="block text-sm font-medium text-gray-700 mb-2">Frequency</label>
                    <select id="frequency" name="frequency" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly" selected>Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <div>
                    <label for="interval" class="block text-sm font-medium text-gray-700 mb-2">Interval</label>
                    <input type="number" id="interval" name="interval" value="{{ recurring_invoice.interval if recurring_invoice else 1 }}" min="1" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div>
                    <label for="start_date" class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                    <input type="date" id="start_date" name="start_date" value="{{ recurring_invoice.start_date.strftime('%Y-%m-%d') if recurring_invoice else '' }}" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div>
                    <label for="end_date" class="block text-sm font-medium text-gray-700 mb-2">End Date (Optional)</label>
                    <input type="date" id="end_date" name="end_date" value="{{ recurring_invoice.end_date.strftime('%Y-%m-%d') if recurring_invoice and recurring_invoice.end_date else '' }}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
            </div>
        </div>

        <!-- Invoice Details -->
        <div>
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Invoice Details</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="currency" class="block text-sm font-medium text-gray-700 mb-2">Currency</label>
                    <select id="currency" name="currency" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        {% for code, currency in config.SUPPORTED_CURRENCIES.items() %}
                        <option value="{{ code }}" {% if (recurring_invoice and recurring_invoice.currency == code) or (not recurring_invoice and code == config.DEFAULT_CURRENCY) %}selected{% endif %}>{{ currency.name }} ({{ code }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="tax_rate" class="block text-sm font-medium text-gray-700 mb-2">Tax Rate (%)</label>
                    <input type="number" id="tax_rate" name="tax_rate" value="{{ (recurring_invoice.tax_rate * 100) if recurring_invoice else (config.TAX_RATE * 100) }}" step="0.01" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
            </div>
        </div>

        <!-- Invoice Items -->
        <div>
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Invoice Items</h2>
            <div id="invoice-items" class="space-y-4">
                <!-- Items will be added here dynamically -->
            </div>
            <button type="button" id="add-item" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition">
                <i class="fas fa-plus mr-2"></i> Add Item
            </button>
        </div>

        <!-- Notes -->
        <div>
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Notes</h2>
            <textarea name="notes" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Enter any notes here...">{{ recurring_invoice.notes if recurring_invoice }}</textarea>
        </div>

        <!-- Submit -->
        <div class="flex justify-end space-x-4 pt-6 border-t">
            <a href="{{ url_for('recurring_invoices.index') }}" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</a>
            <button type="submit" class="px-6 py-3 bg-primary hover:bg-blue-900 text-white font-semibold rounded-lg">Save Recurring Invoice</button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const itemsContainer = document.getElementById('invoice-items');
    const addItemButton = document.getElementById('add-item');
    let itemIndex = 0;

    function addItem(item) {
        itemIndex++;
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('flex', 'gap-4', 'items-center');
        itemDiv.innerHTML = `
            <div class="flex-grow">
                <input type="text" name="description[]" placeholder="Description" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="${item ? item.description : ''}" required>
            </div>
            <div class="w-24">
                <input type="number" name="quantity[]" placeholder="Quantity" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="${item ? item.quantity : 1}" min="0" step="0.01" required>
            </div>
            <div class="w-32">
                <input type="number" name="rate[]" placeholder="Rate" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="${item ? item.rate : ''}" min="0" step="0.01" required>
            </div>
            <div>
                <button type="button" class="remove-item text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
            </div>
        `;
        itemsContainer.appendChild(itemDiv);
    }

    addItemButton.addEventListener('click', () => addItem());

    itemsContainer.addEventListener('click', function(e) {
        if (e.target.closest('.remove-item')) {
            e.target.closest('.flex').remove();
        }
    });

    // Add initial item if creating a new recurring invoice
    {% if not recurring_invoice %}
    addItem();
    {% else %}
        {% for item in recurring_invoice.items %}
        addItem({ description: '{{ item.description|safe }}', quantity: '{{ item.quantity }}', rate: '{{ item.rate }}' });
        {% endfor %}
    {% endif %}
});
</script>
{% endblock %}
