{% extends "base.html" %}

{% block page_title %}Invoice {{ invoice.invoice_number }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Action Buttons -->
    <div class="mb-6 flex justify-between items-center flex-wrap gap-4">
        <div class="flex gap-3">
            <a href="{{ url_for('invoices.download', id=invoice.id) }}"
                class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition">
                <i class="fas fa-download mr-2"></i> Download PDF
            </a>
            {% if invoice.client.email %}
            <form method="POST" action="{{ url_for('invoices.email', id=invoice.id) }}" class="inline">
                <button type="submit"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-envelope mr-2"></i> Email to Client
                </button>
            </form>
            {% else %}
            <span class="bg-gray-100 text-gray-500 px-4 py-2 rounded-lg text-sm">
                <i class="fas fa-envelope mr-2"></i> No client email
            </span>
            {% endif %}
            <a href="{{ url_for('invoices.edit', id=invoice.id) }}"
                class="bg-secondary hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                <i class="fas fa-edit mr-2"></i> Edit
            </a>
        </div>

        <div class="flex gap-2">
            {% if invoice.status == 'draft' %}
            <form method="POST" action="{{ url_for('invoices.update_status', id=invoice.id, status='sent') }}"
                class="inline">
                <button type="submit"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition text-sm">
                    <i class="fas fa-paper-plane mr-1"></i> Mark as Sent
                </button>
            </form>
            {% endif %}

            {% if invoice.status in ['draft', 'sent', 'unpaid', 'overdue'] %}
            <form method="POST" action="{{ url_for('invoices.update_status', id=invoice.id, status='paid') }}"
                class="inline">
                <button type="submit"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition text-sm">
                    <i class="fas fa-check mr-1"></i> Mark as Paid
                </button>
            </form>
            {% endif %}

            <form method="POST" action="{{ url_for('invoices.delete', id=invoice.id) }}" class="inline"
                onsubmit="return confirm('Are you sure you want to delete this invoice?');">
                <button type="submit"
                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition text-sm">
                    <i class="fas fa-trash mr-1"></i> Delete
                </button>
            </form>
        </div>
    </div>

    <!-- Invoice Preview -->
    <div class="bg-white rounded-lg shadow-md p-8">
        <!-- Header -->
        <div class="flex justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold text-primary mb-2">{{ config['BUSINESS_NAME'] }}</h1>
                <p class="text-gray-600 text-sm">{{ config['BUSINESS_ADDRESS'] }}</p>
                <p class="text-gray-600 text-sm">Phone: {{ config['BUSINESS_PHONE'] }}</p>
                <p class="text-gray-600 text-sm">Email: {{ config['BUSINESS_EMAIL'] }}</p>
                {% if config['BUSINESS_WEBSITE'] %}
                <p class="text-gray-600 text-sm">Website: {{ config['BUSINESS_WEBSITE'] }}</p>
                {% endif %}
            </div>
            <div class="text-right">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">INVOICE</h2>
                <span class="inline-block px-4 py-2 rounded-full text-sm font-semibold
                    {% if invoice.status == 'paid' %}bg-green-100 text-green-800
                    {% elif invoice.status == 'sent' %}bg-blue-100 text-blue-800
                    {% elif invoice.status == 'unpaid' %}bg-orange-100 text-orange-800
                    {% elif invoice.status == 'overdue' %}bg-red-100 text-red-800
                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                    {{ invoice.status|upper }}
                </span>
            </div>
        </div>

        <!-- Invoice Details -->
        <div class="grid grid-cols-2 gap-8 mb-8">
            <div>
                <h3 class="text-sm font-bold text-gray-700 mb-3 uppercase">Bill To:</h3>
                <div class="text-gray-800">
                    <p class="font-semibold text-lg">{{ invoice.client.name }}</p>
                    {% if invoice.client.company %}
                    <p class="text-gray-600">{{ invoice.client.company }}</p>
                    {% endif %}
                    {% if invoice.client.address %}
                    <p class="text-gray-600 whitespace-pre-line">{{ invoice.client.address }}</p>
                    {% endif %}
                    {% if invoice.client.email %}
                    <p class="text-gray-600">{{ invoice.client.email }}</p>
                    {% endif %}
                    {% if invoice.client.phone %}
                    <p class="text-gray-600">{{ invoice.client.phone }}</p>
                    {% endif %}
                </div>
            </div>

            <div class="text-right">
                <div class="space-y-2">
                    <div class="flex justify-end">
                        <span class="text-gray-600 w-32 text-left">Invoice #:</span>
                        <span class="font-semibold text-gray-900">{{ invoice.invoice_number }}</span>
                    </div>
                    <div class="flex justify-end">
                        <span class="text-gray-600 w-32 text-left">Issue Date:</span>
                        <span class="font-semibold text-gray-900">{{ invoice.issue_date.strftime('%B %d, %Y') }}</span>
                    </div>
                    <div class="flex justify-end">
                        <span class="text-gray-600 w-32 text-left">Due Date:</span>
                        <span class="font-semibold text-gray-900">{{ invoice.due_date.strftime('%B %d, %Y') }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Items Table -->
        <div class="mb-8">
            <table class="w-full">
                <thead>
                    <tr class="bg-primary text-white">
                        <th class="px-4 py-3 text-left">Description</th>
                        <th class="px-4 py-3 text-right w-24">Quantity</th>
                        <th class="px-4 py-3 text-right w-32">Rate</th>
                        <th class="px-4 py-3 text-right w-32">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in invoice.items %}
                    <tr class="border-b border-gray-200 {% if loop.index is odd %}bg-gray-50{% endif %}">
                        <td class="px-4 py-3 text-gray-800">{{ item.description }}</td>
                        <td class="px-4 py-3 text-right text-gray-700">{{ "%.2f"|format(item.quantity) }}</td>
                        <td class="px-4 py-3 text-right text-gray-700">{{ item.rate|format_currency(invoice.currency) }}
                        </td>
                        <td class="px-4 py-3 text-right font-semibold text-gray-900">{{
                            item.amount|format_currency(invoice.currency) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Totals -->
        <div class="flex justify-end mb-8">
            <div class="w-80">
                <div class="flex justify-between py-2 text-gray-700">
                    <span>Subtotal:</span>
                    <span class="font-semibold">{{ invoice.subtotal|format_currency(invoice.currency) }}</span>
                </div>
                <div class="flex justify-between py-2 text-gray-700">
                    <span>Tax ({{ "%.1f"|format(invoice.tax_rate * 100) }}%):</span>
                    <span class="font-semibold">{{ invoice.tax_amount|format_currency(invoice.currency) }}</span>
                </div>
                <div class="flex justify-between py-3 border-t-2 border-primary text-xl font-bold text-gray-900">
                    <span>Total:</span>
                    <span>{{ invoice.total|format_currency(invoice.currency) }}</span>
                </div>
            </div>
        </div>

        <!-- Notes -->
        {% if invoice.notes %}
        <div class="border-t pt-6">
            <h3 class="text-sm font-bold text-gray-700 mb-2 uppercase">Notes:</h3>
            <p class="text-gray-600 whitespace-pre-line">{{ invoice.notes }}</p>
        </div>
        {% endif %}

        <!-- Footer -->
        <div class="mt-12 pt-6 border-t text-center text-gray-500 text-sm">
            <p>Thank you for your business!</p>
            <p class="mt-1">{{ config['BUSINESS_NAME'] }}</p>
        </div>
    </div>
</div>
{% endblock %}